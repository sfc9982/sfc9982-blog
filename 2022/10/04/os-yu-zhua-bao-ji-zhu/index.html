<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="OS与抓包技术, sfc9982">
    <meta name="description" content="近期在研究 libpcap 和 PF_RING，写篇文章作为总结。
PF_RING 使用
(To be continued)
Snort
https://www.snort.org/
Linux 网络栈


Linux 网络栈

Libpc">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <meta name="google-site-verification" content="VHbds6A71Ln4-2rYPTAdF_Fvy2j0UDrLSa8d4CNXNT0" />
    <!-- Global site tag (gtag.js) - Google Analytics -->

<script async src="https://www.googletagmanager.com/gtag/js?id=G-CVFRQD6QTZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-CVFRQD6QTZ');
</script>


    <title>OS与抓包技术 | sfc9982&#39;s blog</title>
    <link rel="icon" type="image/png" href="/favicon.avif">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="sfc9982's blog" type="application/atom+xml">
</head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.avif" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">sfc9982&#39;s blog</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.avif" class="logo-img circle responsive-img">
        
        <div class="logo-name">sfc9982&#39;s blog</div>
        <div class="logo-desc">
            
            sfc9982 Personal Study Blog of Sci &amp; Tech
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
    </ul>
</div>


        </div>

        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages_anime/astero-202009025a.avif')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">OS与抓包技术</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                          <div class="article-tag">
                            <span class="chip bg-color">无标签</span>
                          </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2022-10-04
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2023-07-19
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    2.4k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    9 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <p>近期在研究 libpcap 和 PF_RING，写篇文章作为总结。</p>
<h2 id="pf_ring-使用">PF_RING 使用</h2>
<p>(To be continued)</p>
<h2 id="snort">Snort</h2>
<p>https://www.snort.org/</p>
<h2 id="linux-网络栈">Linux 网络栈</h2>
<figure>
<img src="https://googles.plus/images/loading.gif" data-original="https://raw.githubusercontent.com/moooofly/ImageCache/master/Pictures/Linux%20%E7%BD%91%E7%BB%9C%E6%A0%88.gif" alt="Linux 网络栈">
<figcaption aria-hidden="true">Linux 网络栈</figcaption>
</figure>
<h2 id="libpcap-抓包系统模型">Libpcap 抓包系统模型</h2>
<figure>
<img src="https://googles.plus/images/loading.gif" data-original="https://raw.githubusercontent.com/moooofly/ImageCache/master/Pictures/Subsystems%20involved%20in%20the%20capturing%20process.png" alt="Subsystems involved in the capturing process">
<figcaption aria-hidden="true">Subsystems involved in the capturing
process</figcaption>
</figure>
<blockquote>
<p>上图为 libpcap 机制涉及的相关内容（简化）；</p>
</blockquote>
<figure>
<img src="https://googles.plus/images/loading.gif" data-original="https://raw.githubusercontent.com/moooofly/ImageCache/master/Pictures/Libpcap%20%E7%9A%84%E5%8C%85%E6%8D%95%E8%8E%B7%E6%9C%BA%E5%88%B6.png" alt="Libpcap 的包捕获机制">
<figcaption aria-hidden="true">Libpcap 的包捕获机制</figcaption>
</figure>
<blockquote>
<p>上图为 libpcap 机制涉及的相关内容（详细）；</p>
</blockquote>
<figure>
<img src="https://googles.plus/images/loading.gif" data-original="https://raw.githubusercontent.com/moooofly/ImageCache/master/Pictures/tcpdump%20%E7%A8%8B%E5%BA%8F%E8%B0%83%E7%94%A8%E6%A8%A1%E5%9E%8B.jpeg" alt="tcpdump程序调用模型">
<figcaption aria-hidden="true">tcpdump程序调用模型</figcaption>
</figure>
<blockquote>
<p>上图标明基于 libpcap
的抓包工具和常规应用程序使用不同的包处理路径（注意：此处的 libpcap
是基于 PF_PACKET 的标准版本）；</p>
</blockquote>
<figure>
<img src="https://googles.plus/images/loading.gif" data-original="https://raw.githubusercontent.com/moooofly/ImageCache/master/Pictures/Elements%20involved%20in%20the%20capture%20process.png" alt="Elements involved in the capture process">
<figcaption aria-hidden="true">Elements involved in the capture
process</figcaption>
</figure>
<blockquote>
<p>这张图细化了 libpcap 的包处理路径（但没有明确指明 BPF 和 tap）；</p>
</blockquote>
<figure>
<img src="https://googles.plus/images/loading.gif" data-original="https://raw.githubusercontent.com/moooofly/ImageCache/master/Pictures/libpcap%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86.jpg" alt="libpcap工作原理">
<figcaption aria-hidden="true">libpcap工作原理</figcaption>
</figure>
<figure>
<img src="https://googles.plus/images/loading.gif" data-original="https://raw.githubusercontent.com/moooofly/ImageCache/master/Pictures/packet%20path.png" alt="packet path">
<figcaption aria-hidden="true">packet path</figcaption>
</figure>
<figure>
<img src="https://googles.plus/images/loading.gif" data-original="https://raw.githubusercontent.com/moooofly/ImageCache/master/Pictures/%E6%8A%93%E5%8C%85%E6%B5%81%E7%A8%8B.png" alt="抓包流程">
<figcaption aria-hidden="true">抓包流程</figcaption>
</figure>
<blockquote>
<p>以上三张图更加细化了 libpcap 的包处理路径，并明确给出了 libpcap
的组成部分有 BPF 和 tap ；但没有提及 libpcap
是在数据链路层上通过旁路进行的包处理，实际通过网络分接头（tap）从位于数据链路层的
NIC driver 中进行的数据包拷贝；</p>
</blockquote>
<figure>
<img src="https://googles.plus/images/loading.gif" data-original="https://raw.githubusercontent.com/moooofly/ImageCache/master/Pictures/BPF%20and%20ZC%20BPF.png" alt="BPF and ZC BPF">
<figcaption aria-hidden="true">BPF and ZC BPF</figcaption>
</figure>
<blockquote>
<p>上图描述了基于 BPF 和 ZC BPF 的标准 libpcap
实现是如何进行数据包读取的；</p>
</blockquote>
<h2 id="数据包接收">数据包接收</h2>
<figure>
<img src="https://googles.plus/images/loading.gif" data-original="https://raw.githubusercontent.com/moooofly/ImageCache/master/Pictures/linux-server-packet-fig-1.png" alt="linux-server-packet-fig">
<figcaption aria-hidden="true">linux-server-packet-fig</figcaption>
</figure>
<blockquote>
<p>这张图给出了很多信息：</p>
<ul>
<li>可能导致丢包问题的两处缓冲区：Ring Buffer 和 poll_queue (per
CPU)；其中 poll_queue 的 size 由内核参数 net.core.netdev_max_backlog
决定，默认为 1000 ；</li>
<li>数据包（由网卡驱动程序）通过 DMA 方式从 NIC Rx queue
拷贝到操作系统内核内存中（Ring Buffer 中保存的是内存索引）；</li>
<li>IRQ 和 softirq</li>
</ul>
</blockquote>
<figure>
<img src="https://googles.plus/images/loading.gif" data-original="https://raw.githubusercontent.com/moooofly/ImageCache/master/Pictures/%E6%95%B0%E6%8D%AE%E5%8C%85%E6%8E%A5%E6%94%B6%E8%B7%AF%E5%BE%84.jpeg" alt="阿里技术保障提供">
<figcaption aria-hidden="true">阿里技术保障提供</figcaption>
</figure>
<blockquote>
<p>这张图提供的有用信息：</p>
<ul>
<li>图中 Poll List 即前图中的 Poll_queue (per CPU) ；</li>
<li>Poll List 每个 CPU 一个，也称之为 backlog ，注意和图中 Socket
backlog 进行区分；</li>
<li>图中给出了 IP 层和 TCP 层的位置，以及两种类型 backlog
所处位置；</li>
</ul>
</blockquote>
<figure>
<img src="https://googles.plus/images/loading.gif" data-original="https://raw.githubusercontent.com/moooofly/ImageCache/master/Pictures/%E7%BD%91%E5%8D%A1%E6%94%B6%E5%8C%85%E6%B5%81%E7%A8%8B%E5%9B%BE.jpeg" alt="网卡收包流程图">
<figcaption aria-hidden="true">网卡收包流程图</figcaption>
</figure>
<blockquote>
<p>上图给出了（单队列网卡）包处理相关的更多信息：</p>
<ul>
<li>物理层：NIC RX queue、NIC memory 和 NIC controller ；</li>
<li>链路层：NIC driver、NAPI、Ring Buffer</li>
<li>网络层：PF_PACKET</li>
<li>数据包通过 DMA 方式从物理层 NIC RX queue 拷贝到操作系统内存中；</li>
<li>NIC memory 中维护的是用于在 Ring Buffer 中进行位置定位的指针；而
Ring Buffer 中的内容为指向保存 DMA 拷贝包的操作系统内存的指针； NIC
controller 通过 NIC memory 中的信息定位 Ring Buffer 的 head
位置，之后触发 IRQ 给 CPU0 ； CPU0 通过 NIC driver、NAPI
机制、PF_PACKET，以及 softirq 完成对操作系统内存中数据包的获取；</li>
</ul>
</blockquote>
<figure>
<img src="https://googles.plus/images/loading.gif" data-original="https://raw.githubusercontent.com/moooofly/ImageCache/master/Pictures/%E5%A4%9A%E9%98%9F%E5%88%97%E7%BD%91%E5%8D%A1%E6%94%B6%E5%8C%85%E6%B5%81%E7%A8%8B%E5%9B%BE.jpeg" alt="多队列网卡收包流程图">
<figcaption aria-hidden="true">多队列网卡收包流程图</figcaption>
</figure>
<blockquote>
<p>多队列网卡与单队列网卡的差别：</p>
<ul>
<li>NIC memory 维护多个 Ring Buffer 的 head/tail 索引信息；</li>
<li>链路层中包含多个 Ring Buffer（针对每个 RX queue 存在一个）</li>
</ul>
</blockquote>
<h2 id="pf_ring-相关">PF_RING 相关</h2>
<figure>
<img src="https://googles.plus/images/loading.gif" data-original="https://raw.githubusercontent.com/moooofly/ImageCache/master/Pictures/Hardware%20Acceleration.png" alt="Hardware Acceleration">
<figcaption aria-hidden="true">Hardware Acceleration</figcaption>
</figure>
<blockquote>
<p>硬件加速卡的实现：FPGA + NIC Memory Map 关键：专用、昂贵</p>
</blockquote>
<figure>
<img src="https://googles.plus/images/loading.gif" data-original="https://raw.githubusercontent.com/moooofly/ImageCache/master/Pictures/PF_RING%20DNA.png" alt="PF_RING DNA">
<figcaption aria-hidden="true">PF_RING DNA</figcaption>
</figure>
<blockquote>
<p>PF_RING DNA 对 Vanilla PF_RING 的改进：NIC NPU + NIC Memory Map
关键：常规 Commodity NIC 即可达到专用硬件加速卡效果；</p>
</blockquote>
<figure>
<img src="https://googles.plus/images/loading.gif" data-original="https://raw.githubusercontent.com/moooofly/ImageCache/master/Pictures/PF_RING-modules.jpeg" alt="PF_RING">
<figcaption aria-hidden="true">PF_RING</figcaption>
</figure>
<h3 id="pf_ring-internals">PF_RING Internals</h3>
<figure>
<img src="https://googles.plus/images/loading.gif" data-original="https://raw.githubusercontent.com/moooofly/ImageCache/master/Pictures/Socket%20Packet%20Ring_PF_RING.png" alt="Socket Packet Ring (PF_RING)">
<figcaption aria-hidden="true">Socket Packet Ring (PF_RING)</figcaption>
</figure>
<figure>
<img src="https://googles.plus/images/loading.gif" data-original="https://raw.githubusercontent.com/moooofly/ImageCache/master/Pictures/PF_RING%20Internals.png" alt="PF_RING Internals">
<figcaption aria-hidden="true">PF_RING Internals</figcaption>
</figure>
<p>值得注意的一个细节：</p>
<ul>
<li><code>netif_receive_skb()</code> 对应 NAPI</li>
<li><code>netif_rx()</code> 对应 No NAPI</li>
</ul>
<h3 id="pf_ring-packet-journey">PF_RING Packet Journey</h3>
<figure>
<img src="https://googles.plus/images/loading.gif" data-original="https://raw.githubusercontent.com/moooofly/ImageCache/master/Pictures/PF_RING%20Packet%20Journey%20-%201.png" alt="PF_RING Packet Journey - 1">
<figcaption aria-hidden="true">PF_RING Packet Journey - 1</figcaption>
</figure>
<figure>
<img src="https://googles.plus/images/loading.gif" data-original="https://raw.githubusercontent.com/moooofly/ImageCache/master/Pictures/PF_RING%20Packet%20Journey%20-%202.png" alt="PF_RING Packet Journey - 2">
<figcaption aria-hidden="true">PF_RING Packet Journey - 2</figcaption>
</figure>
<h2 id="libpcap-v.s.-pf_ring">libpcap v.s. PF_RING</h2>
<figure>
<img src="https://googles.plus/images/loading.gif" data-original="https://raw.githubusercontent.com/moooofly/ImageCache/master/Pictures/PF_RING%20and%20legacy%20architecture.png" alt="PF_RING and legacy architecture">
<figcaption aria-hidden="true">PF_RING and legacy
architecture</figcaption>
</figure>
<blockquote>
<p>PF_RING 的地位和 PF_PACKET 是类似的，本质上都是向内核注册了一种
socket 类型；图中有一个地方画错了，即 Linux Network Stack
上方应该是非抓包的其它服务，如 telnet 和 tftp 等；</p>
</blockquote>
<figure>
<img src="https://googles.plus/images/loading.gif" data-original="https://raw.githubusercontent.com/moooofly/ImageCache/master/Pictures/PF_RING%20and%20PF_PACKET%20under%20Linux.png" alt="PF_RING and PF_PACKET under Linux">
<figcaption aria-hidden="true">PF_RING and PF_PACKET under
Linux</figcaption>
</figure>
<blockquote>
<p>基于 PF_PACKET 和 PF_RING 两种方式下的包处理路径对比：明显 PF_RING
路径更短；这也就是为何 PF_RING 速度更快，更不容易丢包的原因；</p>
<p>另外，需要注意，Ethernet driver 和 Low-level packet reception 之间的
<code>netif_rx()</code>/<code>netif_receive_skb()</code> 分别对应了 No
NAPI 和 NAPI ；而从 Ethernet driver
上进行包搬移操作的应该是之前提及的、作为 libpcap
组成部分之一的、网络分接头 tap ；</p>
<p><strong>PF_RING</strong> is a replacement for
<strong>PF_PACKET</strong> that not only uses memory mapping instead of
processing expensive buffer copies from kernel space to userspace, but
it also uses <strong>ring buffers</strong> making to transportation in a
more efficient way.</p>
</blockquote>
<h2 id="napi-v.s.-tnapi">NAPI v.s. TNAPI</h2>
<h3 id="napi">NAPI</h3>
<figure>
<img src="https://googles.plus/images/loading.gif" data-original="https://raw.githubusercontent.com/moooofly/ImageCache/master/Pictures/Enhanced%20NIC%20Drivers_Linux%20NAPI.png" alt="Enhanced NIC Drivers_Linux NAPI">
<figcaption aria-hidden="true">Enhanced NIC Drivers_Linux
NAPI</figcaption>
</figure>
<figure>
<img src="https://googles.plus/images/loading.gif" data-original="https://raw.githubusercontent.com/moooofly/ImageCache/master/Pictures/Linux%20NAPI%20Limitations%20-%201.png" alt="Linux NAPI Limitations">
<figcaption aria-hidden="true">Linux NAPI Limitations</figcaption>
</figure>
<blockquote>
<p>上面两图说明：传统的 NAPI + RSS 方案存在问题，即 NAPI 对多 RX queue
是顺序轮询的，并且在 driver 和用户应用的接口层存在 Merge &amp; Split
等资源竞争问题；</p>
</blockquote>
<h3 id="tnapi">TNAPI</h3>
<figure>
<img src="https://googles.plus/images/loading.gif" data-original="https://raw.githubusercontent.com/moooofly/ImageCache/master/Pictures/Enhanced%20NIC%20Drivers_TNAPI.png" alt="Enhanced NIC Drivers_TNAPI">
<figcaption aria-hidden="true">Enhanced NIC Drivers_TNAPI</figcaption>
</figure>
<blockquote>
<p>上图说明：基于 TNAPI + PF_RING 解决了传统 NAPI 方案遇到的问题；</p>
</blockquote>
<figure>
<img src="https://googles.plus/images/loading.gif" data-original="https://raw.githubusercontent.com/moooofly/ImageCache/master/Pictures/Explaiting%20PF_RING%20Multi-Queue_nProbe.png" alt="Explaiting PF_RING Multi-Queue_nProbe">
<figcaption aria-hidden="true">Explaiting PF_RING
Multi-Queue_nProbe</figcaption>
</figure>
<figure>
<img src="https://googles.plus/images/loading.gif" data-original="https://raw.githubusercontent.com/moooofly/ImageCache/master/Pictures/nCap%20and%20Legacy.png" alt="nCap and Legacy">
<figcaption aria-hidden="true">nCap and Legacy</figcaption>
</figure>
<hr>
<h2 id="libpcap-抓包原理"><a target="_blank" rel="noopener" href="https://www.oschina.net/action/GoToLink?url=http%3A%2F%2Fblog.163.com%2Fnobody_ppc%2Fblog%2Fstatic%2F35239432008330111658963">libpcap
抓包原理</a></h2>
<p>libpcap (Packet Capture Library)，即数据包捕获函数库，是 Unix/Linux
平台下的网络数据包捕获函数库。它是一个独立于系统的用户层包捕获的 API
接口，为底层网络监测提供了一个可移植的框架。</p>
<h3 id="libpcap-工作原理">libpcap 工作原理</h3>
<p>libpcap 主要由两部份组成：</p>
<ul>
<li>网络分接头（Network Tap）</li>
<li>数据过滤器（Packet Filter）</li>
</ul>
<p><strong>网络分接头从网络设备驱动程序（NIC
driver）中收集数据拷贝，过滤器决定是否接收该数据包</strong>。Libpcap
利用 BSD Packet Filter (BPF)
算法对网卡接收到的链路层数据包进行过滤。</p>
<p><strong>BPF 算法的基本思想</strong>：在有 BPF
监听的网络中，网卡驱动将接收到的数据包复制一份交给 BPF
过滤器，过滤器根据用户定义的规则决定<strong>是否接收此数据包</strong>以及<strong>需要拷贝该数据包的哪些内容</strong>，然后将过滤后的数据交给与过滤器相关联的上层应用程序。</p>
<p><strong>libpcap
的包捕获机制</strong>：<strong>在数据链路层加一个旁路处理</strong>。当一个数据包到达网络接口时，libpcap
首先利用已经创建的类型为 PF_PACKET 的 Socket
，从位于<strong>链路层</strong>中的 NIC driver
中获得数据包的拷贝，再通过 Tap 函数将数据包发给 BPF 过滤器。BPF
过滤器根据用户已经定义好的过滤规则对数据包进行逐一匹配，匹配成功则放入内核缓冲区，进而传递给用户缓冲区，匹配失败则直接丢弃。如果没有设置过滤规则，所有数据包都将放入内核缓冲区，并传递给用户缓冲区。</p>
<h3 id="libpcap-的抓包框架">libpcap 的抓包框架</h3>
<ul>
<li><code>pcap_lookupdev()</code> 函数用于查找网络设备，返回可被
<code>pcap_open_live()</code> 函数调用的网络设备名指针。</li>
<li><code>pcap_open_live()</code>
函数用于打开网络设备，并且返回用于捕获网络数据包的数据包捕获描述字。对于此网络设备的操作都要基于此网络设备描述字。</li>
<li><code>pcap_lookupnet()</code>
函数获得指定网络设备的网络号和掩码。</li>
<li><code>pcap_compile()</code>
函数用于将用户制定的过滤策略编译到过滤程序中。</li>
<li><code>pcap_setfilter()</code> 函数用于设置过滤器。</li>
<li><code>pcap_loop()</code> 函数 <code>pcap_dispatch()</code>
函数用于捕获数据包，捕获后还可以进行处理，此外 <code>pcap_next()</code>
和 <code>pcap_next_ex()</code> 两个函数也可以用来捕获数据包。</li>
<li><code>pcap_close()</code> 函数用于关闭网络设备，释放资源。</li>
</ul>
<h3 id="libpcap-mmap">libpcap-mmap</h3>
<p>libpcap-mmap 是 libpcap
的一个改进版本，它们捕获数据包的结构相同。不同的地方主要有以下两点：</p>
<ul>
<li>libpcap
使用固定大小的<strong>存储缓冲器</strong>和<strong>保持缓冲器</strong>来完成数据包从内核缓冲区到用户缓冲区的传递，而
libpcap-mmap
设计了一个大小可以配置的<strong>循环缓冲器</strong>，允许用户程序和内核程序同时对该循环缓冲器的不同数据区域进行直接的读取。</li>
<li>在 libpcap 中，当网卡接收到一个数据包之后，网卡驱动程序通过 DMA
方式调用系统函数 <code>netif_rx()</code> 将数据包从网卡（Rx
queue）拷贝到核心态内存，应用程序想访问位于核心态内存的数据时，就必须将数据包从核心态内存中拷贝到用户态内存中（即<strong>两次拷贝问题</strong>），这种方式会占用了很多系统资源，降低数据包捕获的性能以及对数据包的处理能力。而
<strong>libpcap-mmap 采用 MMAP
技术，建立核心态内存和用户态内存的映射</strong>，将系统分配给网卡设备文件的核心态内存映射到一块用户态内存，这样应用程序就可以通过系统函数
<code>recvfrom()</code>
把数据包从网卡设备文件对应的核心态内存上直接传送到用户态内存；</li>
</ul>
<hr>
<p><code>Libpcap</code> is one of the more vastly open source library
for packet capturing and uses by default <strong>PF_PACKET</strong>
protocol in order to transfer the packets from the driver to the
userspace.</p>
<p>It is the de facto library that facilitates the packet transition
from kernel onto the userspace is libpcap. It provides an API for the
programmer to select the capturing interface (device) and gives the
ability to compile <strong>Linux Packet Filters (LPF)</strong> into the
kernel for selective packet capturing based on the 5 tuple (protocol,
source/destination IP address and source/destination port).</p>
<p>One important feature of <strong>PF_RING</strong> is the way it
exchanges packets between user space and kernel: Monitoring applications
usually access a library like <code>libpcap</code> to retrieve captured
packets from the kernel. Libpcap is an abstraction from the operating
systems’ capturing mechanisms and allows to run a capturing application
on several operating systems without porting it to the special capturing
architecture. Back in 2004, the then current libpcap version
<strong>0.9.8</strong> used a <strong>copy operation</strong> to pass
packets from the kernel to the user space on Linux. An unofficial patch
against that libpcap version from Phil Woods existed, which replaced the
copy operation by a <strong>shared memory area</strong> that was used to
exchange packets between kernel and application. This modification will
be called MMAP throughout the rest of the paper. PF RING uses a similar
structure to exchange packets by default. Libpcap version
<strong>1.0.0</strong>, which was released in late 2008, is the first
version that ships built-in shared memory (SHM) exchange support; hence
the patch from Phil Woods is not longer necessary.</p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://googles.plus" rel="external nofollow noreferrer">sfc9982</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                    </span>
                <span class="reprint-info">
                    <a href="https://googles.plus/2022/10/04/os-yu-zhua-bao-ji-zhu/">https://googles.plus/2022/10/04/os-yu-zhua-bao-ji-zhu/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY-NC-ND 4.0</a>
                    许可协议。转载请注明来源
                    <a href="https://googles.plus" target="_blank">sfc9982</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            <span class="chip bg-color">无标签</span>
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2022/10/04/gou-jian-ntop-liu-liang-bu-zhuo-ji-lu-fen-xi-huan-jing/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages_anime/2d29d75b9c1c3cd8d0c67db2dad16a04.avif" class="responsive-img" alt="构建 ntop 流量捕捉/记录/分析环境">
                        
                        <span class="card-title">构建 ntop 流量捕捉/记录/分析环境</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2022-10-04
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E7%BD%91%E7%BB%9C%E5%B7%A5%E7%A8%8B/" class="post-category">
                                    网络工程
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/ntop/">
                        <span class="chip bg-color">ntop</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2022/10/04/linux-xia-tong-ji-zhong-duan-shu-chu-xing-shu/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages_anime/948576470.avif" class="responsive-img" alt="Linux下统计终端输出行数">
                        
                        <span class="card-title">Linux下统计终端输出行数</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2022-10-04
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            sfc9982
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="song"
                   id="5213502"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='one'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    

    <div class="container row center-align"
         style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            <a href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral" target="_blank">
                本网站由
                <img border="0" height="26" src="/images/upyun.png" align="center">
                提供CDN加速/云存储服务
            </a>
            <br>
            
            <a href="https://www.cloudflare.com/" target="_blank">
                CDN Services for countries and regions out of Mainland China are powered by
                <img border="0" height="18" src="/images/CF_logo_horizontal_whitetype.svg" align="top">
            </a>
            <br>
            Copyright&nbsp;&copy;
            
                <span id="year">2021-2023</span>
            
            <a href="/about" target="_blank">sfc9982</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            <br>
            
                &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                        class="white-color">200.3k</span>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
                <span id="sitetime"> Loading ...</span>
                <script>
                    var calcSiteTime = function () {
                        var seconds = 1000;
                        var minutes = seconds * 60;
                        var hours = minutes * 60;
                        var days = hours * 24;
                        var years = days * 365;
                        var today = new Date();
                        var startYear = "2021";
                        var startMonth = "11";
                        var startDate = "7";
                        var startHour = "0";
                        var startMinute = "0";
                        var startSecond = "0";
                        var todayYear = today.getFullYear();
                        var todayMonth = today.getMonth() + 1;
                        var todayDate = today.getDate();
                        var todayHour = today.getHours();
                        var todayMinute = today.getMinutes();
                        var todaySecond = today.getSeconds();
                        var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                        var diff = t2 - t1;
                        var diffYears = Math.floor(diff / years);
                        var diffDays = Math.floor((diff / days) - diffYears * 365);

                        // 区分是否有年份.
                        var language = 'zh-CN';
                        if (startYear === String(todayYear)) {
                            document.getElementById("year").innerHTML = todayYear;
                            var daysTip = 'This site has been running for ' + diffDays + ' days';
                            if (language === 'zh-CN') {
                                daysTip = '本站已运行 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                daysTip = '本站已運行 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = daysTip;
                        } else {
                            document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                            var yearsAndDaysTip = 'This site has been running for ' + diffYears + ' years and '
                                + diffDays + ' days';
                            if (language === 'zh-CN') {
                                yearsAndDaysTip = '本站已运行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                yearsAndDaysTip = '本站已運行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = yearsAndDaysTip;
                        }
                    }

                    calcSiteTime();
                </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/sfc9982/" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:admin@googles.plus" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=2120935182" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 2120935182" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


<!--
    <canvas class="fireworks" style="position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;" ></canvas> 
    <script type="text/javascript" src="/js/fireworks.js"></script>
-->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>

<!--     <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css">
    <script src="/live2d-widget/autoload.js"></script>
 -->
    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    
    <script type="text/javascript" src="/libs/background/ribbon-dynamic.js" async="async"></script>
    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

<script src="https://cdn.jsdelivr.net/npm/live2d-widget@^3.1.3/lib/L2Dwidget.min.js"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/mikoto.model.json"},"display":{"position":"left","width":250,"height":500},"mobile":{"show":false},"log":false});</script>
        <style>
            [bg-lazy] {
                background-image: none !important;
                background-color: #eee !important;
            }
        </style>
        <script>
            window.imageLazyLoadSetting = {
                isSPA: false,
                preloadRatio: 2,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script><script>!function(r){r.imageLazyLoadSetting.processImages=t;var e=r.imageLazyLoadSetting.isSPA,n=r.imageLazyLoadSetting.preloadRatio||1,c=a();function a(){var t=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")),e=Array.prototype.slice.call(document.querySelectorAll("[bg-lazy]"));return t.concat(e)}function t(){e&&(c=a());for(var t,o=0;o<c.length;o++)0<=(t=(t=c[o]).getBoundingClientRect()).bottom&&0<=t.left&&t.top<=(r.innerHeight*n||document.documentElement.clientHeight*n)&&function(){var t,e,n,a,i=c[o];e=function(){c=c.filter(function(t){return i!==t}),r.imageLazyLoadSetting.onImageLoaded&&r.imageLazyLoadSetting.onImageLoaded(i)},(t=i).hasAttribute("bg-lazy")?(t.removeAttribute("bg-lazy"),e&&e()):(n=new Image,a=t.getAttribute("data-original"),n.onload=function(){t.src=a,t.removeAttribute("data-original"),e&&e()},t.src!==a&&(n.src=a))}()}function i(){clearTimeout(t.tId),t.tId=setTimeout(t,500)}t(),document.addEventListener("scroll",i),r.addEventListener("resize",i),r.addEventListener("orientationchange",i)}(this);</script></body>

</html>
